# LAB 2: `mmap` 和 `munmap` 匿名映射

### 功能总结
(1) `sys_get_time` 和 `sys_task_info` 两个函数的实现和上一个实验大同小异, 只是在写入数据的时候需要在一个 `[u8]` 里写, 同时需要处理变量被分在两页的情况 (虽然好像不处理也能过测例)  

(2) `mmap` 和 `munmap`: 先判断需要映射/解除映射的页是否符合条件, 再调用 `MemorySet` 提供的函数完成内存的申请和释放.  

### 简答题

1. SV39 页表项的组成:  
   `[63:54]`: 保留  
   `[53:10]`: 物理页号, 分成长度分别为 26、9、9 的三段  
   `[9:8]`: 保留  
   `[7:0]`: 标志位, 依次为:  
   - Dirty `D`: 记录自从页表项上的这一位被清零之后，页表项的对应虚拟页表是否被修改过.  
   - Accessed `A`: 记录自从页表项上的这一位被清零之后，页表项的对应虚拟页面是否被访问过.  
   - Global `G`: 该页在所有地址空间中都是可见的，无需通过 TLB 查找.  
   - User `U`: 是否可以在 U 特权级下访问.  
   - E*x*ecutable `X`: 是否可以执行指令.  
   - Writable `W`: 是否可写.  
   - Readable `R`: 是否可读.  
   - Valid `V`: 页表项是否有效.  

2. 缺页  
    (1) 请问哪些异常可能是缺页导致的?  
    > 从 Trap 处理的代码可知, 至少 `StoreFault`, `StorePageFault`, `LoadFault`, `LoadPageFault` 可能是由缺页导致的.  

    (2) 发生缺页时，描述相关重要寄存器的值, 上次实验描述过的可以简略.  
    > `sstatus`: 记录了进入 Trap 前的特权等级  
      `sepc`: 进入 Trap 前执行的最后一条指令的地址  
      `sscratch`: 指向用户栈  
      `sp`: 指向应用的 `TrapContent`
      `satp`: 内核页表所在地址

    (3) 这样做有哪些好处?  
    > 这样做可以减少一些页表映射操作, 加快程序启动时间.  

    (4) 处理 10G 连续的内存页面，对应的 SV39 页表大致占用多少内存 (估算数量级即可)?  
    > 10G 对应 2621400 页, 需要 5120 个二级节点和 10 个一级节点, 大致占用 $2621400\times 8+5130\times 4096≈40~\text{MB}$

    (5) 请简单思考如何才能实现 Lazy 策略, 缺页时又如何处理? 描述合理即可, 不需要考虑实现.  
    > 记录程序每个段所在的磁盘位置, 在触发缺页相关异常的时候把需要的数据读取到内存并建立一个新的映射.  

    (6) 此时页面失效如何表现在页表项 (PTE) 上?  
    > V 标记会被置为 0.  

3. 双页表与单页表  
    (1) 在单页表情况下, 如何更换页表?  
    > ...  

    (2) 单页表情况下，如何控制用户态无法访问内核页面？(Tips:看看上一题最后一问)  
    > 把 U 标记置为 0 即可.  

    (3) 单页表有何优势? (回答合理即可)  
    > ...  

    (4) 双页表实现下, 何时需要更换页表? 假设你写一个单页表操作系统, 你会选择何时更换页表 (回答合理即可)?  
    > 在双页表下, 在触发 Trap、从 Trap 返回、调度任务的时候会更换页表. 在单页表下, ...   

### 荣誉准则
1. 在完成本次实验的过程（含此前学习的过程）中，我曾分别与 以下各位 就（与本次实验相关的）以下方面做过交流，还在代码中对应的位置以注释形式记录了具体的交流对象及内容：
   > 1. ChatGPT: 如何像 C 语言一样转成指定指针然后写数据 (`sys_get_time`)

2. 此外，我也参考了 以下资料 ，还在代码中对应的位置以注释形式记录了具体的参考来源及内容：
    > 无

3. 我独立完成了本次实验除以上方面之外的所有工作，包括代码与文档。 我清楚地知道，从以上方面获得的信息在一定程度上降低了实验难度，可能会影响起评分。

4. 我从未使用过他人的代码，不管是原封不动地复制，还是经过了某些等价转换。 我未曾也不会向他人（含此后各届同学）复制或公开我的实验代码，我有义务妥善保管好它们。 我提交至本实验的评测系统的代码，均无意于破坏或妨碍任何计算机系统的正常运转。 我清楚地知道，以上情况均为本课程纪律所禁止，若违反，对应的实验成绩将按“-100”分计。